{% extends "layout.html" %}
{% block title %}{{data.palmname}}{% endblock %}
{% block head %}
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
{% endblock %}
{% block header %}
{% from 'header_block.html' import small_header with context %}
{{ small_header(data.palmname, data.commonname if data.commonname is not none) }}
{% endblock %}

{% block content %}


<div class="mt-0">
    <a target="_blank"
        href="https://www.palmtalk.org/forum/search/?&q=%22{{data.palmname}}%22&quick=1&search_and_or=or&sortby=relevancy">
        <i class="fa-solid fa-arrow-up-right-from-square"></i> Search PalmTalk</a>
    &nbsp;

    <a target="_blank" href="https://palmpedia.net/wiki/index.php5?search={{data.palmname}}">
        <i class="fa-solid fa-arrow-up-right-from-square"></i> Search PalmPedia</a></p>
</div>

<div class="stat-columns">
    <div class="stat-column" id="zone"></div>
    <div class="stat-column" id="lowest-survived-temp"></div>
    <div class="stat-column" id="num-events"></div>
    <div class="stat-column" id="num-observations"></div>
</div>

<div class="table-container">
    <div id="observation-table">
    </div>
</div>

{% include 'observation_temp_cell.html' %}

<script src="{{ url_for('static', filename='js/vanilla_table.js') }}"></script>
<script src="{{ url_for('static', filename='js/statcard.js') }}"></script>
<script src="{{ url_for('static', filename='js/palm_observation_table.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/statcard.css') }}">

<script>
    const CardType = {
        LOWESTSURVIVED: 'LOWESTSURVIVED',
        NUMEVENTS: 'NUMEVENTS',
        NUMOBSERVATIONS: 'NUMOBSERVATIONS',
        MOSTCOMMONLOCATION: 'MOSTCOMMONLOCATION',
        MOSTREPORTEDBY: 'MOSTREPORTEDBY'
    };

    const zone = `{{data.zonename}}`
    const zone_label = `
<div class="dropdown is-hoverable">
    <div class="dropdown-trigger">
        <p class="pl-2">USDA Zone <i class="fa-solid fa-circle-info is-size-7" aria-haspopup="true"
                aria-controls="zone-help"></i></p>
    </div>
    <div class="dropdown-menu" id="zone-help" role="menu">
        <div class="dropdown-content">
            <div class="dropdown-item is-size-7 has-text-weight-normal">
                <p>USDA Hardiness Zones are based on the average annual minimum
                    temperature.</p>
                <a target="_blank" href="https://planthardiness.ars.usda.gov/"> <i
                        class="fa-solid fa-arrow-up-right-from-square"></i> More info at
                    usda.gov</a>
            </div>
        </div>
    </div>
</div>
`

    async function loadCard(type) {
        const url = `/api/palm/{{data.id}}/stat/${type}`

        // Always attempt to read from localstorage to save bandwidth.
        let localStorageData = getFromLocalStorage(url)
        if (localStorageData)
            return localStorageData

        // Fetch from the server. The item(s) are not in localstorage.
        try {
            const response = await fetch(url)
            if (!response.ok) {
                throw new Error('Network response was not OK.', response)
            }

            const contentType = response.headers.get("content-type")
            if (!contentType || !contentType.includes("application/json"))
                throw new TypeError(`Expected JSON response but got something else: \'${contentType}\'`)

            const json = await response.json()
            saveToLocalStorage(url, json)
            return json
        } catch (error) {
            console.error('Failed to fetch the card data.', error)
            return ''
        }
    }

    window.onload = async function () {
        const cards = [
            new StatCard(document.getElementById('zone'), zone_label, zone),
            new StatCard(document.getElementById('lowest-survived-temp'), 'Lowest survived', '', () => { return loadCard('LOWESTSURVIVED') }),
            new StatCard(document.getElementById('num-events'), 'Events', '', () => { return loadCard('NUMEVENTS') }),
            new StatCard(document.getElementById('num-observations'), 'Observations', '', () => { return loadCard('NUMOBSERVATIONS') }),
        ]

        createObservationTable()
    }
</script>

{% endblock %}